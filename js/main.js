var turnsInput = [
        {
            "x": 5,
            "y": 4,
            "health": 2,
            "turn": 0,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 3,
            "health": 2,
            "turn": 0,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 2,
            "health": 2,
            "turn": 0,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "atX": 3,
            "atY": 1,
            "x": 5,
            "y": 2,
            "health": 2,
            "turn": 1,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 3,
            "atY": 1,
            "x": 5,
            "y": 2,
            "health": 2,
            "turn": 1,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 1,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 1,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 1,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "atX": 3,
            "atY": 1,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 2,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 3,
            "atY": 1,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 2,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 2,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 2,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 2,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "atX": 3,
            "atY": 1,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 3,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 3,
            "atY": 1,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 3,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 3,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 3,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 3,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 3,
            "y": 1,
            "health": 0,
            "attacker": "ships.DeltaShip@3ef86d9b",
            "turn": 4,
            "id": "games.DummyShip@2979dc98",
            "type": "SINK"
        },
        {
            "atX": 3,
            "atY": 1,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 4,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 3,
            "atY": 1,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 4,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 4,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 4,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 4,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "atX": 4,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 5,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 4,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 5,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 5,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 5,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 5,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "atX": 4,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 6,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 4,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 6,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 6,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 6,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 6,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "atX": 4,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 7,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 4,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 7,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 7,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 7,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 7,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 4,
            "y": 0,
            "health": 0,
            "attacker": "ships.DeltaShip@3ef86d9b",
            "turn": 8,
            "id": "games.DummyShip@21b573b3",
            "type": "SINK"
        },
        {
            "atX": 4,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 8,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 4,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 8,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 8,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 8,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 8,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "atX": 5,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 9,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 5,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 9,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 9,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 9,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 9,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "atX": 5,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 10,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 5,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 10,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 10,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 10,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 10,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "atX": 5,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 11,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 5,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 11,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 11,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 11,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 11,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 0,
            "health": 0,
            "attacker": "ships.DeltaShip@3ef86d9b",
            "turn": 12,
            "id": "games.DummyShip@5d88b413",
            "type": "SINK"
        },
        {
            "atX": 5,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 12,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "atX": 5,
            "atY": 0,
            "x": 5,
            "y": 1,
            "health": 2,
            "turn": 12,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "FIRE"
        },
        {
            "x": 5,
            "y": 0,
            "health": 2,
            "turn": 12,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 0,
            "health": 2,
            "turn": 12,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 0,
            "health": 2,
            "turn": 12,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        }
    ]

var shipsInput = [
            {
                "owner": "Vinesh",
                "firepower": 2,
                "name": "Delta Ship",
                "x": 5,
                "y": 5,
                "range": 3,
                "id": "ships.DeltaShip@3ef86d9b",
                "hull": 2,
                "speed": 3
            },
            {
                "owner": "The Evil Fleet",
                "firepower": 1,
                "name": "Dummy Ship",
                "x": 4,
                "y": 0,
                "range": 1,
                "id": "games.DummyShip@21b573b3",
                "hull": 7,
                "speed": 1
            },
            {
                "owner": "The Evil Fleet",
                "firepower": 1,
                "name": "Dummy Ship",
                "x": 5,
                "y": 0,
                "range": 1,
                "id": "games.DummyShip@5d88b413",
                "hull": 7,
                "speed": 1
            },
            {
                "owner": "The Evil Fleet",
                "firepower": 1,
                "name": "Dummy Ship",
                "x": 3,
                "y": 1,
                "range": 1,
                "id": "games.DummyShip@2979dc98",
                "hull": 7,
                "speed": 1
            },
            {
                "owner": "The Evil Fleet",
                "firepower": 1,
                "name": "Dummy Ship",
                "x": 6,
                "y": 1,
                "range": 1,
                "id": "games.DummyShip@5410f899",
                "hull": 7,
                "speed": 1
            }
        ];

var oceanInput = {
	"x": 10,
	"y": 10
};

function battleship() {
	
	// private
	var m_Constants = {
		CameraYOffset: 4,
		OceanYOffset: 0,
		ShipYOffset: 0,
		WaitTimeToStartSimulate: 10,
		WaitTimeBetweenTurn: 5,
		WaitTimeBetweenAction: 1 
	};

	var m_ocean;
	var m_ships = {};
	var m_turns;
    var m_chain = [];

	// public
	var app = {

		getJSON: () => {
			// to be implemented
		},

        preprocess: (turnData) => {
            var actions = [];
            var index = 0;
            //var count = 0;

            while(index < turnData.length-1) {
                var chain = true;
                while(chain) {
                    if (index == turnData.length)
                        break;

                    if (actions.length === 0) {
                        actions.push(turnData[index]);
                        index++;
                    }
                    // Ship id and action type has to be the same to be considered a chain-able action
                    else if (actions[0].id === turnData[index].id && actions[0].type === turnData[index].type) {
                        if (actions[0].type === "MOVE") {
                            actions.push(turnData[index]);
                            index++;
                        }
                        // Firing must be at the same coordinates to be considered a chain-able action
                        else if (actions[0].type === "FIRE" && actions[0].atX === turnData[index].atX && actions[0].atY === turnData[index].atY) {
                            actions.push(turnData[index]);
                            index++;
                        }
                        else if(actions[0].type === "SINK") {
                            actions.push(turnData[index]);
                            index++;
                        }
                        else {
                            chain = false;
                        }
                    }
                    else {
                        chain = false;
                    }
                }
                // add
                m_chain.push({"type": actions[0].type, "actions": actions});
                // reset chain actions
                actions = [];
            }
        },

		init: () => {
			m_ocean = oceanInput;
			m_turns = turnsInput;
            app.preprocess(turnsInput);
			app.render(shipsInput);
			// call function to wait a bit before starting simulation
			app.simulate();
		},


		// Displays the ocean, and ships
		// TODO: check the edge cases with the map edges/sizes
		render: (shipData) => {
			var doc = document.getElementById('scene'); // <a-scene> reference

			// re-position camera: camera must be already present when html loads
			var camera = document.getElementById('camera');
			camera.setAttribute('position', (4*Math.floor(m_ocean.x/2))+" "+m_Constants.CameraYOffset+" "+(4*Math.floor(m_ocean.y/2)));
			camera.setAttribute('camera', 'userHeight: '+m_Constants.CameraYOffset);
			
			// Generate Map
			// TODO: Possible edge cases with the map edge not being big enough
			var map = document.createElement('a-ocean');

			map.setAttribute('position', (4*Math.floor(m_ocean.x/2)+2)+" "+m_Constants.OceanYOffset+" "+(4*Math.floor(m_ocean.y/2)+2));
			map.setAttribute('width', (4*m_ocean.x)+"");
			map.setAttribute('depth', (4*m_ocean.y)+"");
			map.setAttribute('density', Math.min(3*m_ocean.x, 3*m_ocean.y)+"");
			doc.appendChild(map);

			// Spawn Ships
			shipData.forEach((entry) => {
				var coord = {"x": entry.x, "y": entry.y};
				var ship = document.createElement('a-collada-model');
				ship.setAttribute('position', app.getCoord(coord, m_Constants.ShipYOffset));
				ship.dataset.id = entry.id;
				ship.dataset.name = entry.name;
				ship.dataset.owner = entry.owner;
				ship.dataset.x = entry.x;
				ship.dataset.y = entry.y;
				ship.dataset.health = entry.hull;
				ship.dataset.hull = entry.hull;
				ship.dataset.firepower = entry.firepower;
				ship.dataset.speed = entry.speed;
				ship.dataset.range = entry.range;
				ship.setAttribute('src', '#ship');
				doc.appendChild(ship);
                m_ships[entry.id] = ship;

			});

		},

        // Data passed in must be weapon firing of one ship, coordinates may differ
        fireShip: (data) => {
            var fireCoords = [{"x": 3, "y": 1, "shots": 3}];
            data.forEach((entry) => {

            });
        },

		// Data passed in must be for movement of one ship
		moveShip: (data) => {
			var doc = document.getElementById('scene'); // <a-scene> reference
            var ship = m_ships[data[0].id]; // html element

            var track = document.createElement('a-curve');
            track.setAttribute('id', 'track');
            doc.appendChild(track);

            data.forEach((entry) => {
                var coord = app.getCoord({"x": entry.x, "y": entry.y}, m_Constants.ShipYOffset);
                var point = document.createElement('a-curve-point');
                point.setAttribute('position', coord);
                track.appendChild(point);
            });

            ship.setAttribute('alongpath', 'curve: #track; rotation: true; constraint: 0 0 1; delay: 3000; dur: 5000;');

		},

		simulate: () => {
			var actions = []; // store atomic actions
			var index = 0;

			while(index < m_turns.length-1) {

				var atomic = true;
				while(atomic) {
                    if (index == m_turns.length)
                        break;

					if (actions.length === 0) {
						actions.push(m_turns[index]);
                        index++;
					}
					else if (actions[0].id === m_turns[index].id && actions[0].type === m_turns[index].type){
						actions.push(m_turns[index]);
                        index++;
					}
					else {
						atomic = false;
					}
				}
				// start plotting a path for the ship to move
				if (actions[0].type === "MOVE") {
					app.moveShip(actions);
				}
                else if (actions[0].type === "FIRE") {
                    app.fireShip(actions);
                }
				// reset atomic actions
				actions = [];
			}
			var tmp = [
        {
            "x": 5,
            "y": 4,
            "health": 2,
            "turn": 0,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 3,
            "health": 2,
            "turn": 0,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        },
        {
            "x": 5,
            "y": 2,
            "health": 2,
            "turn": 0,
            "id": "ships.DeltaShip@3ef86d9b",
            "type": "MOVE",
            "direction": "North"
        }];

        app.moveShip(tmp);


		},

		/** translates the coordinate in the java game to this scene's coordinate
			Java Game: Each ship spans one (x, y) unit
			Java Game: Coordinate system has (0, 0) at top left corner (without negatives)
			AFrame Scene: Each ship model is a 4x4 box
			AFrame Scene: Coordinate system is (0, 0) at the center (with negatives)
		*/
		getCoord: (coord, offsetY) => {
			return (m_ocean.x-coord.x)*4 + " " + offsetY + " " + (m_ocean.y-coord.y)*4;
		},

		getShips: () => {
			return m_ships;
		}

	}

	return app;
}

var app = battleship();
app.init();






